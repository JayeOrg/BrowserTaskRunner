services:
    sitecheck:
        container_name: sitecheck
        build:
            context: ../..
            dockerfile: stack/infra/Dockerfile
            args:
                - SOURCE_HASH=${SOURCE_HASH:-unknown}
        environment:
            - TASK_NAME
            - SITE_EMAIL
            - SITE_PASSWORD
            - SITE_CHECK_INTERVAL_MS=${SITE_CHECK_INTERVAL_MS:-300000}
            - VAULT_PASSWORD
            - ENABLE_VNC=${ENABLE_VNC:-true}
            - DOCKER=true
            # Configurable display/port settings (match run.sh defaults)
            - DISPLAY_NUM=${DISPLAY_NUM:-99}
            - WS_PORT=${WS_PORT:-8765}
        ports:
            - "5900:5900" # VNC for debugging
            - "${WS_PORT:-8765}:${WS_PORT:-8765}" # WebSocket
        volumes:
            - ../../logs:/app/logs
            - ../../vault.enc:/app/vault.enc:ro
        tmpfs:
            - /tmp/chrome-profile
        restart: on-failure
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "node -e \"s=require('net').createConnection(process.env.WS_PORT||8765,'localhost');s.on('connect',()=>{s.end();process.exit(0)});s.on('error',()=>process.exit(1));setTimeout(()=>process.exit(1),3000)\"",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 30s
