# Rejected: Extension & Browser

Won't-fix decisions for `stack/extension/` and `stack/browser/`. Check before proposing changes to these modules.

- **`clicks.ts` CDP fallback logging**: `cdpClickAt` silently falls back to DOM click when CDP attach fails (lines 39, 59). Logging here would be noisy — CDP attach fails routinely when debugger is already attached, and the fallback is intentional. The caller already logs click results.
- **`browser.ts` helper type `ClickTextOptions` is not exported**: It's an implementation detail of the BrowserAPI interface, only used as a parameter type. Callers construct it as an object literal — exporting would suggest it's meant to be referenced by name.
- **Extension `log()` function is minimal**: It's a `console.log` wrapper with a prefix. Don't suggest replacing with a logging library — this runs in a Chrome service worker where simplicity matters more than features.
- **`browser.ts` method named `type` clashes with TS keyword culture**: `type` is the standard name used by Playwright and Puppeteer. Renaming would confuse anyone coming from those frameworks.
- **`cdpClickSelector` naming compounds mechanism and input strategy**: Matches the established `cdp` + action pattern used by `cdpClick`. The name clearly signals "CDP click, resolved by selector."
- **`StepUpdate.state` includes "idle"**: The "idle" state in the overlay's `StepUpdate` type is the overlay's initial rendering state before any step update arrives from StepRunner. StepRunner never emits "idle" — it's a client-side-only concept for the overlay's pre-update display. Removing it would leave the overlay with no state before the first step begins.
- **`PingCommand` and `GetUrlCommand` are manually typed instead of schema-derived**: Their schemas are `z.object({})` which infers to `Record<string, never>` — combining this with `& { type: "ping" }` creates an impossible type because the `type` key conflicts with the `never` index signature. Manual typing is correct here.
- **`getReconnectDelay` in `connection.ts` has an intermediate variable**: One line — the extra variable makes debugging easier (breakpoint on the return). Inlining saves nothing meaningful.
- **`terminate` vs `close` naming in `browser.ts`**: `close()` cleanly shuts down the WebSocket server. A separate `terminate()` for force-close was suggested but isn't needed — `close()` already handles the shutdown path, and there's no scenario where a graceful close fails that a force-terminate would solve.
- **`send()` dual guard in `browser.ts`**: `send()` has both a `readyState` guard and a `try/catch` — these serve different purposes. The early guard rejects cheaply without registering a pending command. The try/catch handles errors after registration. Both are needed.
- **`close()` comment mentions "close handler" but code calls `ws.terminate()`**: `terminate()` fires the `close` event in the `ws` library, so the comment is accurate about the handler being involved.
- **`charToKeyCode` fallback for non-ASCII returns wrong code silently in `keyboard.ts`**: Only used with known key names and ASCII characters. Non-ASCII input is not a supported use case for CDP key dispatch.
- **`ensureConnection()` throws synchronously in `send()` (browser.ts:232)**: `send()` returns `new Promise(...)` (not `async`), so `ensureConnection()` throws synchronously rather than rejecting. All call sites `await` the result, so the caller's `async` function catches it. The scenario requiring a rejection (storing the Promise without awaiting) doesn't exist.
- **Second WebSocket connection silently overwrites `this.ws` (browser.ts:169)**: Docker runs one Chrome instance with one extension. A second connection can't happen in the current architecture.
- **`DEFAULT_TIMEOUT_MS` 10000 vs navigate's 30000 undocumented in `wait-for-selector.ts`**: Different operations have different defaults. Documenting every constant difference adds noise.
- **`to`/`by` scroll modes use a boolean flag in `scroll.ts`**: Only two modes. A string discriminant for two values is premature.
- **Race window between `waitForTabLoad` and `chrome.tabs.update` in `navigate.ts`**: Listener is registered before `update` — correct ordering. The edge case is a Chrome API limitation that can't be fixed.
- **`hasKey` helper is generic but called once in `messages/index.ts`**: Provides proper type narrowing (`key is Extract<keyof T, string>`). Inlining would lose this narrowing or require a cast.
- **`ResponseFor` utility type not in README**: Internal type used only in `browser.ts`. Not part of the task-author API.
- **Emoji button labels hardcoded in `overlay/dom.ts`**: Display text, not logic. `ControlAction` types are enforced by TypeScript.
- **Tab listener fires for all tabs, `changedTabId === tabId` check in `tabs.ts`**: Only one tab is used, but the check is still needed because Chrome fires the event for all tabs. The guard is correct and trivially cheap.
- **`getFrameId` exact URL match could miss query param differences**: Exact match is correct for current use cases (iframe `src` attributes don't typically differ by query params from Chrome's frame list). A comment documents the limitation and the fuzzy-matching alternative if needed later.
- **`extractResult` returning generic "Script did not execute" for both missing-frame and navigation cases**: The two causes are indistinguishable at the API level (`results[0]?.result` is `undefined` in both cases). Adding a heuristic would be fragile. A comment now documents the dual meaning.
- **`StepUpdateMessage` and `StepState` field names (`current`/`total`/`name`)**: Names are correct and consistent with `StepRunner` emissions. `current`/`total` clearly convey index-of-total semantics. No rename needed.
- **`formatTime` helper in `extension/logging.ts` only called once**: 3 lines of date formatting. Inlining into `log()` would reduce readability. Extracting small formatting helpers is standard.
- **No `blur` event after fill in `extension/messages/commands/fill.ts`**: Adding `blur` would change behavior for all sites. Current sequence (focus -> value -> input -> change) works. Speculatively adding it risks unwanted side effects. If needed, add as an option per-command.
- **Redundant `if (elements)` guards in `extension/overlay/controls.ts`**: TypeScript's control flow analysis doesn't narrow module-level variables across function calls. Without the guards, `elements.foo` is a type error. Guards are required by the type checker, not redundant.
- **Adding error field to `CdpClickSelectorResult`**: CDP click recovers by coordinate — it doesn't need error details on failure. `SelectorResult` has `error` because DOM click callers use it for diagnostics. The types serve different callers with different needs.
- **Extracting `xpathString` from `click-text.ts` injected function**: The function must run in the page context because it constructs XPath expressions that depend on the page's XPath engine. Pre-building XPath strings on the host side would mean building and passing complex strings — more brittle than the current approach. The function handles a well-known XPath quoting edge case (mixed apostrophes and quotes).
- **`cdpClickSelector` zero-area guard `||` vs `&&` comment**: The condition `width <= 0 || height <= 0` is straightforward. Commenting `||` vs `&&` on a simple guard is over-commenting.
- **`poll.ts` / `wait-for-selector.ts` use `while (Date.now() < deadline)` loop**: These ARE the implementations backing the AGENTS.md rule. The rule targets task code that should use `pollUntil`, not the polling primitives themselves. Obvious from context.
- **`mousePressed` on CDP send failure in `clicks.ts`**: If `chrome.debugger.attach` succeeds but `sendCommand("mousePressed")` throws, Chrome never processed the event — no orphaned mouse state. The `finally` block detaches the debugger, which resets input state. Zero practical impact.
- **Unifying `waitForText` (accepts `string[]`) and `waitForUrl` (accepts `string`)**: Different use cases: text matching needs alternatives ("Order confirmed" vs "Thank you") because sites vary. URL matching is against a known path fragment. Adding array support to `waitForUrl` would be over-engineering.
- **Block comment style in `browser.ts:437-442`**: The `close()` method uses a `/* */` block comment while the rest of the file uses `//`. Using `/* */` for multi-sentence explanations and `//` for single-line annotations is a common, readable convention. The block comment visually signals "this is a paragraph of explanation."
